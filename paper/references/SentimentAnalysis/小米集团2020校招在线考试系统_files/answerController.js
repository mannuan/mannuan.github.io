var editor,uploadId,filrUrl,downName,tuUrl;var backName,backUrl,timer;app.register("answerController",["$scope","$http","$state","$stateParams","$location","$timeout","App",function($scope,$http,$state,$stateParams,$location,$timeout,App){$("#navTab").hide();$scope.private="-----BEGIN PRIVATE KEY-----MIICdwIBADANBgkqhkiG9w0BAQEFAASCAmEwggJdAgEAAoGBANF2K2iRtLDr48je3USa9kgYdt9zGYTraDno5bBleweOTgkfuXbViXvI4rLe4XTjPfQnXtsuY3Lj8TaejfvGo5a5TtGF5qJLWeiRdoNTXeF/T1//ubtjFwOA0NV2hk6fSZe9bj89VBjv7rGfZoCcwFRjeySWnKnsux5S3VAljOdfAgMBAAECgYEAmREV37C6rp9zMhNK9xuW5lCabegaufuditQbJbDDG15uwFQioCij84V1xOkDMPvvBkDPHLTlj8vrNdLgRyF94RBT9uOoaz67Ba/vBuRCuVdCAJzVuLYl5F2HVEFeLM5Qoe9q053UJynyMaSzWOtCX8cGgK9wcuBKg5QYOkcyfWECQQD0UzT5wX7S5PT5C2uzM5Zn9D6qOAgXwA6I426SFdYwLmwSfBmXoZBzSfwae7VxKiEocGsrW9V3S83MhP5Ce9htAkEA23h7upxTF2/nPhPyo7oujsvVHYn3evwoalHXp4K39KWdM/Q/YxL1SSvHHz48mzOdjZVc9ImUHjZl2Xoh8+63ewJAcGxJGBNdFBWeU2pZ6F94eeT9YL3fm24YQgzEuBusLwdtWyQXcpo5KZOFmXoLB0NndoAkEBN1qisLS2x2wojSEQJARh+9COch9X8f18nv4Th/38hpE8MdfAJNt4rm6PLvbA/upscH6dQI45RFT0pHex+G29I5nTjIRs8Cw/YuGw7POQJBAOhYBUAJLxV8q3Z+pRQnJPvm8DlFq4Fr75UTI9PPAvzLBhhwm9Yk64urUEwIGFP3tYusS0Tti2DJRmXJYzeI5OI=-----END PRIVATE KEY-----";$timeout(function(){selTab("answer")});$scope.App=App;window.scrollTo(0,0);$scope.loading=false;$scope.model={};$scope.answer="";$scope.isPc=true;if(document.body.clientWidth<800){$scope.isPc=false}$scope.paperId=App.paperId=$stateParams.paperId;$scope.quesNo=App.quesNo=parseInt($stateParams.quesNo);$scope.direction=parseInt($stateParams.direction);$scope.$on("timeing.usedTime",function(e,d){});$scope.$on("main.submitAPaper",function(e,d){$scope.submitPaper()});$scope.$on("main.gotoQuestion",function(e,paperId,rowNumber){$scope.goToQuestion(paperId,rowNumber)});$scope.$on("timeOver.submitNow",function(e,d){console.log("timeOver.submitNow");$scope.autoSubmitPaper()});$scope.$on("practise.timeOver",function(e,d){console.log("practise.timeOver");gotoHash("#/main/rules");$(".examtitle .titleright").remove()});$scope.cePinOptionChangeo=function(o,index){if(o.answer==undefined||o.answer==null||o.answer==""){o.answer="";$(".mainbody.forall .innerInfo .examInfo .exammiddle .optionlist ul li.cePinli"+index).find('input[type="text"]').val("");$scope.getDistributionFraction();return}if(!/^\d([0-9])?$/.test(o.answer)){if(o.oldAns){if(o.answer.toString().length>1){o.answer=o.oldAns}else{o.answer=""}}else{o.answer=""}return}if(parseFloat(o.answer)>10){if(o.oldAns){o.answer=o.oldAns}else{o.answer=""}return}if($scope.model.ques&&$scope.model.ques.options){var total=10;var now=0;$scope.model.ques.options.forEach(function(item){if(item.answer&&!isNaN(item.answer)&&item.answer!==""){now+=parseFloat(item.answer)}});if(now>total){o.answer=""}else{o.oldAns=o.answer}$scope.getDistributionFraction()}else{o.answer="";$scope.getDistributionFraction();return}};$scope.loadCepinQuesAns=function(){if($scope.model.answer&&$scope.model.answer!=""){var ansArr=$scope.model.answer.split(",");for(var i=0;i<ansArr.length;i++){if($scope.model.ques.options[i]){if(ansArr[i]!=undefined&&!isNaN(ansArr[i])){$scope.model.ques.options[i].answer=parseFloat(ansArr[i])}}}}};$scope.getDistributionFraction=function(){$scope.model.ques.distributionFraction=0;var total=10;var now=0;$scope.model.ques.options.forEach(function(item){if(item.answer!=undefined&&!isNaN(item.answer)&&item.answer!==""){now+=parseFloat(item.answer)}else{item.answer=""}});var fscore=total-now;if(fscore.toString()!=""&&fscore.toString().length>3){fscore=fscore.toFixed(1)}if(parseInt(fscore)==parseFloat(fscore)){$scope.model.ques.distributionFraction=parseInt(fscore)}else{$scope.model.ques.distributionFraction=parseFloat(total-now).toFixed(1)}};$scope.goToQuestion=function(paperId,rowNumber){var ans=$scope.getAnswer();if($scope.checkAnswer(ans,1)=="limited500"){cxalertWarn(ACM.lang.hint,ACM.lang.answer.limited500);return}$scope.saveAnswerAction(ans,function(){var strTo="answer";if(App.paper.forCode)strTo="onlinecode";gotoHash("#/main/{2}/{0}/{1}/0".Format(App.paper._id,rowNumber,strTo))})};$scope.autoSubmitPaper=function(){var ans=$scope.getAnswer();$scope.saveAnswerActionFun(ans,function(){$.cxDialog.close();$http.post("/cand/api/addLog",{action:"submitPaper",paperId:$scope.paperId}).success(function(data){}).error(function(data){});App.submitAPaperDo($http,$state,$scope.paperId,function(r){if(App.serverTime.usedTime>=0){gotoHash("#/main/start")}else{gotoHash("#/main/practise")}})})};$scope.submitPaper=window.submit=function(){var ans=$scope.getAnswer();if($scope.checkAnswer(ans,1)=="limited500"){cxalertWarn(ACM.lang.hint,ACM.lang.answer.limited500);return}if($scope.model.ques&&$scope.model.ques.questype==11&&ans==""){var score=0;if($scope.model.ques.distributionFraction){score=$scope.model.ques.distributionFraction}cxalertWarn(ACM.lang.hint,'您还有 <span style="font-size:20px;color:#ff0000;font-weight:bold;">'+score+"</span> 分没有分配到选项<br>请分配完，再提交试题！");return}$scope.saveAnswerAction(ans,function(){var checkAnsSave=App.checkQuesSave();if(Object.isNullString(checkAnsSave)){$http.post("/cand/api/addLog",{action:"submitPaper",paperId:$scope.paperId}).success(function(data){}).error(function(data){});App.submitAPaper($http,$state,$scope.paperId,function(r){if(App.serverTime.usedTime>=0){gotoHash("#/main/start")}else{gotoHash("#/main/practise")}})}else{cxalert(ACM.lang.hint,ACM.lang.answer.quesNotSaveTip.Format(checkAnsSave))}})};$scope.next=function(rowNumber){var ans=$scope.getAnswer();if($scope.checkAnswer(ans,1)==false&&$scope.model.paper.quesPrev==false){if($scope.model.ques&&$scope.model.ques.questype==11){var score=0;if($scope.model.ques.distributionFraction){score=$scope.model.ques.distributionFraction}cxalertWarn(ACM.lang.hint,'您还有 <span style="font-size:20px;color:#ff0000;font-weight:bold;">'+score+"</span> 分没有分配到选项<br>请分配完，再提交试题！")}else{cxalertWarn(ACM.lang.hint,ACM.lang.answer.canNotBeBack)}return}else{if($scope.checkAnswer(ans,1)!="limited500"){$scope.saveAnswerAction(ans,function(){gotoHash("#/main/answer/{0}/{1}/{2}".Format($scope.paperId,rowNumber,1))})}}};$scope.prev=function(rowNumber){var ans=$scope.getAnswer();if($scope.checkAnswer(ans,0)!="limited500"){$scope.saveAnswerAction(ans,function(){gotoHash("#/main/answer/{0}/{1}/{2}".Format($scope.paperId,rowNumber,-1))})}};$scope.cb={};$scope.cbs=0;$scope.reportError=function(title,content){$http.post("/test/reportError",{url:title,error:content}).success(function(data,header,config,status){}).error(function(data,header,config,status){});if(window.ACMGlobal&&typeof window.ACMGlobal.remainingTime=="number"&&window.ACMGlobal.remainingTime<=0){if(ACM&&ACM.lang.lang=="en"){location.href="https://cdn.acmcoder.com/release/exam/2.0.2/htmls/exam/autosubmit_en.html"}else{location.href="https://cdn.acmcoder.com/release/exam/2.0.2/htmls/exam/autosubmit.html"}}};$scope.saveAnswerAction=function(ans,callback){if(window.ACMGlobal.quesTime!=undefined&&window.ACMGlobal.quesTime%3!=0){$.post("/cand/api/addCustomCalculateTime",{cpid:$scope.model._id,time:window.ACMGlobal.quesTime%3},function(data){})}if(window.ACMGlobal.upload!=undefined&&window.ACMGlobal.upload.uploading==true){cxConfirm(ACM.lang.answer.fileUploading,function(){window.ACMGlobal.upload.uploading=false;$.cxDialog.close();$scope.saveAnswerActionFun(ans,callback)})}else{$scope.saveAnswerActionFun(ans,callback)}};$scope.saveAnswerActionFun=function(ans,callback){var rnd=$scope.cbs++;if(!Object.isNullString(ans)||Object.isNullString(ans)&&(App.ques.fileUrl!=undefined&&App.ques.fileUrl!="")||$scope.model.ques.questype==5&&window.ACMGlobal.emptySave==1){if(App.paper.forPractise){$http.post("/cand/api/addLog",{action:"practice",paperId:App.paperId,quesId:$scope.model.pqId}).success(function(data){}).error(function(data){})}else{$http.post("/cand/api/addLog",{action:"answer",paperId:App.paperId,quesId:$scope.model.pqId}).success(function(data){}).error(function(data){})}App.ques.answer=ans;App.saveQues(App.paperId,App.ques,false);(function(p,q,r){$http({url:"/cand/api/saveAnswer",method:"post",data:{paperId:$scope.paperId,quesNo:$scope.model.rowNumber,ans:q.answer,fileUrl:App.ques.fileUrl,fileName:App.ques.fileName,tu:tuUrl}}).then(function(resp){var data=resp.data,header=resp.headers,config=resp.config,status=resp.status;var blSucc=false;if(App.checkData(data,$state)){if(data&&data.code==1){blSucc=true}}else{}if(data.e){$scope.reportError(location.href,JSON.stringify({user:user,resp:resp,data:data,header:header,config:config,status:status}))}if(blSucc==false){if(data&&data.e==-11){cxalertBack(ACM.lang.hint,ACM.lang.answer.haveSubmited,function(){gotoHash("#/main/start")})}else if(data&&data.e==-12){cxalertBack(ACM.lang.hint,ACM.lang.answer.haveSubmited,function(){gotoHash("#/main/start")})}else if(data&&data.e==-13){cxalertBack(ACM.lang.hint,ACM.lang.answer.examEnd,function(){gotoHash("#/main/start")})}else if(data&&data.e==-15){location.href="/cand/index";return}else if(data==-99){cxalertBack(ACM.lang.hint,ACM.lang.answer.accountInvalid,function(){location.href="/cand/login";return})}else{if(JSON.stringify(data)=="{}"){}else{$scope.reportError(location.href,JSON.stringify({user:user,data:data,header:header,config:config,status:status}))}cxalertWarn(ACM.lang.hint,ACM.lang.answer.notSaveAnswerFirst)}}if(r==$scope.cbs-1||blSucc)App.saveQues(p,q,blSucc);if(r==$scope.cbs-1)$timeout(callback);return},function(resp){var data=resp.data,header=resp.headers,config=resp.config,status=resp.status;if(r==$scope.cbs-1){if($scope.model.paper!=undefined&&$scope.model.paper.quesPrev==false){cxalertWarn(ACM.lang.hint,ACM.lang.answer.notSaveChangeNet);App.saveQues(p,q,false);App.updateFromServer($http,$state)}else{cxalertWarn(ACM.lang.hint,ACM.lang.answer.notSaveAnswerFirst);App.saveQues(p,q,false);$timeout(callback);App.updateFromServer($http,$state)}}$scope.reportError(location.href,JSON.stringify({type:"error",user:user,resp:resp}))})})(App.paperId,App.ques,rnd)}else{if(App.paper.forPractise){$http.post("/cand/api/addLog",{action:"practice",quesId:$scope.model.pqId}).success(function(data){}).error(function(data){})}else{$http.post("/cand/api/addLog",{action:"answer",quesId:$scope.model.pqId}).success(function(data){}).error(function(data){})}if(rnd==$scope.cbs-1)$timeout(callback)}};$scope.saveAnswer=function(rowNumber){var ans=$scope.getAnswer();if($scope.checkAnswer(ans,1)=="limited500"){cxalertWarn(ACM.lang.hint,ACM.lang.answer.limited500);return}if(Object.isNullString(ans)&&$scope.model.ques.questype!=5){cxalert(ACM.lang.hint,ACM.lang.answer.notGiveAnswer);return}else if(Object.isNullString(ans)&&$scope.model.ques.questype==5&&($scope.model.fileUrl==undefined||$scope.model.fileUrl=="")&&window.ACMGlobal.emptySave!=1){cxalert(ACM.lang.hint,ACM.lang.answer.notGiveAnswer);return}else{$scope.saveAnswerAction(ans,function(){cxalert(ACM.lang.hint,ACM.lang.answer.saveSuccessfull)})}};$scope.checkAnswer=function(ans,direction){if($scope.model.ques.questype==4){var countNum=ans;if(countNum.length>5e3){cxalertWarn(ACM.lang.hint,ACM.lang.answer.limited500);return"limited500"}}else if($scope.model.ques.questype==5){var ans1="";if($scope.isPc){ans1=editor.getData();var countNum=ans1.replace(/<[^>]*>/g,"").replace(/&nbsp;/g,"").replace(/\n/g,"");if(countNum.length>5e3){cxalertWarn(ACM.lang.hint,ACM.lang.answer.limited500);return"limited500"}}else{ans1=$("#txtAnswer").val()}}if($scope.model.ques.questype==5&&($scope.model.fileUrl!=undefined&&$scope.model.fileUrl!="")){return true}if($scope.model.ques.questype==5&&window.ACMGlobal.emptySave==1){return true}{if(Object.isNullString(ans)){if(direction==1){cxalert(ACM.lang.hint,ACM.lang.answer.notGiveAnswer)}else{console.log(ACM.lang.answer.notGiveAnswer)}return false}else return true}};$scope.checkAnswer2=function(ans,direction){if($scope.model.ques.questype==4){var countNum=ans;if(countNum.length>5e3){cxalertWarn(ACM.lang.hint,ACM.lang.answer.limited500);return"limited500"}}else if($scope.model.ques.questype==5){var ans1="";if($scope.isPc){ans1=editor.getData();var countNum=ans1.replace(/<[^>]*>/g,"").replace(/&nbsp;/g,"").replace(/\n/g,"");if(countNum.length>5e3){cxalertWarn(ACM.lang.hint,ACM.lang.answer.limited500);return"limited500"}}else{ans1=$("#txtAnswer").val()}}if($scope.model.ques.questype==5&&($scope.model.fileUrl!=undefined&&$scope.model.fileUrl!="")){return true}{if(Object.isNullString(ans)){return false}else return true}};$scope.getAnswer=function(){var ans="";if($scope.model.ques){switch($scope.model.ques.questype){case 4:var ansArr=[];var ansBool=false;$(".inputQuesAnsList .inputQuesLi input").each(function(){ansArr.push($(this).val());if($(this).val()!=""){ansBool=true}});ans=ansArr.join("@@");if(window.ACMGlobal.HtmlUtil){ans=window.ACMGlobal.HtmlUtil.htmlEncode(ans)}if(!ansBool){ans=""}break;case 5:if($scope.isPc){ans=editor.getData()}else{ans=$("#txtAnswer").val()}break;case 1:case 3:ans=$('input[type="radio"][name="rdo"]:checked').val();break;case 2:var cbs=$('input[type="checkbox"][name="cb"]:checked');var arr=[];for(var i=0;i<cbs.length;i++)arr.push(cbs[i].value);ans=arr.join(",");break;case 7:var cbs=$('input[type="checkbox"][name="cb"]:checked');var arr=[];for(var i=0;i<cbs.length;i++)arr.push(cbs[i].value);ans=arr.join(",");break;case 11:if($scope.model.ques&&$scope.model.ques.options){var ansArr=[];var totalScore=0;$scope.model.ques.options.forEach(function(item){if(item&&item.answer){ansArr.push(parseFloat(item.answer));totalScore+=parseFloat(item.answer)}else{ansArr.push("")}});if(totalScore==10){ans=ansArr.join(",")}}break}}return ans};var uploader=null;$scope.pluploadConfig=function(){if(window.plupload){uploader=new plupload.Uploader({runtimes:"html5",browse_button:"pickfiles",container:document.getElementById("fileUploadContainer"),url:"https://examacmcoder.oss-cn-beijing.aliyuncs.com",resize:{width:2e3,height:2e3,crop:false,preserve_headers:false},init:{PostInit:function(){if(uploader.files.length>0){uploader.start()}},FilesAdded:function(up,files){var len=up.files.length;if(len>1){up.removeFile(up.files[0])}},UploadProgress:function(up,file){$("#loadingNum").html(file.percent);$("#loadingWC .loadingNC").css({width:file.percent+"%"});$scope.uploaderModel.percent=file.percent},UploadComplete:function(up,files){$("#loadingWC .loadingNC").css({width:100+"%"});$("#loadingWC").css({display:"none"});$scope.uploaderModel.loading=false;$scope.UploadComplete()},Error:function(up,err){if(up&&up.files&&up.files.length){var len=up.files.length;if(len>1){up.removeFile(up.files[0])}}}}});uploader.init()}};$scope.uploaderModel={name:"",url:"",percent:0};$scope.UploadComplete=function(){App.ques.fileName=$scope.uploaderModel.name;App.ques.fileUrl=$scope.uploaderModel.url;var alink='target="_blank" href="'+$scope.uploaderModel.url+'"';if(!$scope.isPc){alink=""}if(App.ques.fileName!=undefined&&App.ques.fileName!=""){$("#loaclFileDiv span.showTitle").html('<a class="downHref" '+alink+">"+App.ques.fileName.replace(/ /g,"")+'</a> <span class="downClose"><i class="fa fa-times"></i></span>');$("#loaclFileDiv .downClose").unbind("click").bind("click",function(){$(this).closest(".showTitle").html("");$scope.model.fileUrl=$scope.model.fileName=""})}$("#fileText").remove();$(".dialog_uploadfile").append('<input type="file" id="fileText" name="fileText" style="margin-bottom: 10px;display: none;"/>')};$scope.uploadStart=function(){if(uploader){var checkedFile,fileName,url;checkedFile=$("#fileText")[0].files[0];if(checkedFile.size>10485760){window.cxalert(ACM.lang.hint,ACM.lang.answer.upload10M);return}fileName=App.ques._id;if(App.myInfo){fileName+="-"+App.myInfo.guid}fileName+=checkedFile.name.substring(checkedFile.name.lastIndexOf("."));$scope.uploaderModel.name=checkedFile.name.replace(/ /g,"");$scope.uploaderModel.url="https://cdn.acmcoder.com/photo/monitor/"+fileName+"?v="+Math.random();$.get("/cand/api/ossmonitor",{},function(data){if(data){var accessid=data.accessid;var dir=data.dir;var expire=data.expire;var host=data.host;var policy=data.policy;var signature=data.signature;var new_multipart_params={key:dir.replace(/\\/g,"")+fileName,policy:policy,OSSAccessKeyId:accessid,success_action_status:"200",signature:signature};host=host.replace("http:","https:");uploader.setOption({multipart_params:new_multipart_params});uploader.addFile(checkedFile,dir.replace(/\\/g,"")+fileName);$scope.uploaderModel.percent=0;$("#loaclFileDiv").show();$("#loadingWC").css({display:"block"});$("#loadingNum").html("0");$("#loadingWC .loadingNC").css({width:0+"%"});$timeout(function(){uploader.start()})}})}};var refreshFunc=function(){tuUrl=undefined;window.ACMGlobal.emptySave=0;$scope.loading=true;App.paper=App.getPaper($scope.paperId);App.Papers=[App.paper];if(App.paper==null){cxalert(ACM.lang.hint,ACM.lang.answer.paperSending);$timeout(function(){gotoHash("#/main/rules")});return}var idx=0;if($scope.quesNo>-1){if($scope.direction>0)idx=App.quesNo/100+1;else if($scope.direction<0)idx=App.quesNo/100-1;else idx=App.quesNo/100}var data=App.getQues($scope.paperId,idx*100);if(data==null){cxalert(ACM.lang.hint,ACM.lang.answer.quesSending,function(){gotoHash("#/main/start")});$timeout(function(){gotoHash("#/main/start")});return}data.code=0;data.paper=App.paper;App.ques=data;uploadId=data._id;App.paperAns=App.getPapersAllAns(App.paperId);for(var i=0;i<App.paperAns.length;i++){delete App.paperAns[i].$$hashKey}$scope.model=data;window.focusAellow=$scope.model.ques.popupWindow;if($scope.model.ques.questype==11){$scope.loadCepinQuesAns();$scope.getDistributionFraction()}if($scope.model.ques.fenzhi.toString().length>5){$scope.model.ques.fenzhi=$scope.model.ques.fenzhi.toString().substring(0,$scope.model.ques.fenzhi.toString().indexOf(".")+2)}App.rowNumber=rowNumber=data.rowNumber;$http.post("/cand/api/addLog",{action:"enterQues",paperId:App.paperId,quesId:$scope.model.pqId}).success(function(data){}).error(function(data){});$scope.loading=false;if(App.ques.ques.questype==4&&App.ques.ques.answerNum!=undefined){if(App.ques.ques.answerNumExt==undefined){App.ques.ques.answerNumExt=[];if(App.ques.answer!=undefined&&App.ques.answer!=""){var ansList=App.ques.answer.split("@@");for(var i=0;i<ansList.length;i++){App.ques.ques.answerNumExt.push({value:ansList[i]})}}else{for(var i=0;i<App.ques.ques.answerNum;i++){App.ques.ques.answerNumExt.push({value:""})}}}}else{App.ques.ques.answerNumExt=[];App.ques.ques.answerNum=1;if(App.ques.answer!=undefined&&App.ques.answer!=""){App.ques.ques.answerNumExt.push({value:App.ques.answer})}else{App.ques.ques.answerNumExt.push({value:""})}}$timeout(function(){console.log(App);if(App.ques&&App.ques.ques.questype&&App.ques.ques&&App.ques.ques.questype&&App.ques.ques.questype==5&&App.ques.ques.assist&&App.ques.ques.assist.s5==1){$scope.pluploadConfig()}if(App.ques&&App.ques.ques&&App.ques.ques.assist&&App.ques.ques.assist.s11==1){$(".mainbody.forall .innerInfo .examInfo .exammiddle .questionIntro").addClass("bgGray")}if($scope.model.ques){switch($scope.model.ques.questype){case 4:$("#txtAnswer").val($scope.model.answer);break;case 5:$("#txtAnswer").val($scope.model.answer);if($scope.isPc){window.editor=CKEDITOR.replace("txtAnswer");CKEDITOR.on("instanceReady",function(e){try{if($scope.model.fileUrl!=undefined&&$scope.model.fileUrl!=""){$("#loaclFileDiv").show();$("#loaclFileDiv .downClose").unbind("click").bind("click",function(){$(this).closest(".showTitle").html("");$scope.model.fileUrl=$scope.model.fileName="";$scope.uploaderModel.name=$scope.uploaderModel.url="";window.ACMGlobal.emptySave=1;$("#loaclFileDiv").hide()})}else{}}catch(e){}$("iframe.cke_wysiwyg_frame")[0].contentDocument.onblur=function(){$("#txtAnswer").focus()};if($scope.model.ques.assist!=undefined&&$scope.model.ques.assist.s6==1){$(window.editor.document.$).find("body").addClass("letter")}else{$(window.editor.document.$).find("body").removeClass("letter")}if($(".wordCount").length==0){$(editor.container.$.childNodes[1].childNodes[2]).append('<span class="wordCount"></span>')}editor.document.on("keyup",function(){var ansCount=editor.getData();ansCount=ansCount.replace(/<[^>]*>/g,"").replace(/&nbsp;/g,"").replace(/\n/g,"").length;$(editor.container.$.childNodes[1].childNodes[2]).find(".wordCount").html(ACM.lang.answer.nowWords+"<span>"+ansCount+"</span> / 5000");if(ansCount>5e3){if(localStorage["wordCountLimit"+$scope.model.ques._id]){if(parseInt(localStorage["wordCountLimit"+$scope.model.ques._id])<Date.now()-5*60*1e3){return}}localStorage["wordCountLimit"+$scope.model.ques._id]=Date.now();cxalert(ACM.lang.hint,ACM.lang.answer.limited500);if(!$(".wordCount").hasClass("animateFont")){$(".wordCount").addClass("animateFont")}}else{$(".wordCount").removeClass("animateFont")}})})}$(".saveAnswerBtn").show();break;case 1:case 3:if(!Object.isNullString($scope.model.answer)){ans=$('input[type="radio"][name="rdo"][value="{0}"]'.Format($scope.model.answer)).attr("checked","checked")}break;case 2:if(!Object.isNullString($scope.model.answer)){var arr=$scope.model.answer.split(",");for(var i=0;i<arr.length;i++){$('input[type="checkbox"][name="cb"][value="{0}"]'.Format(arr[i])).attr("checked","checked")}}break;case 7:if(!Object.isNullString($scope.model.answer)){var arr=$scope.model.answer.split(",");for(var i=0;i<arr.length;i++){$('input[type="checkbox"][name="cb"][value="{0}"]'.Format(arr[i])).attr("checked","checked")}}break}}$(".onlinetest").hide();$(".mianall").addClass("foranswer").removeClass("forcode");if(parseInt($(".mainbody .innerInfo").css("height"))<540){$(".footer").css("position","fixed")}else{$(".footer").css("position","")}$(".mainbody.forall .innerInfo .examInfo .exammiddle .simpleoptionlist ul li").bind("click",function(){$(this).siblings().removeClass("selected").find("i.choose").removeClass("fa fa-check");$(this).addClass("selected").find("i.choose").addClass("fa fa-check");$(this).siblings().find("input").removeAttr("checked");$(this).find("input").prop("checked",true)});if($(".tipinfo").length==0){$(".qnumb_qums").after('<div class="tipinfo"><div class="info clearfix"><div class="fr light"></div><span class="tip">'+ACM.lang.main.tip+"</span><br><span>"+ACM.lang.answer.carefullyRead+"</span></div></div>")}if(isMobile){$(".questionIntro").find("img").each(function(){if(parseInt($(this).css("width"))>=parseInt($(".answerBody").width())){$(this).css("width","100%").css("height","")}if($(this).attr("style")==undefined){$(this).css("width","100%").css("height","")}});$(".exammiddle .InputBoxArea .uploadfile").hide()}$(".mainbody.forall .innerInfo .examInfo .exammiddle .multioptionlist ul li").bind("click",function(){if($(this).hasClass("selected")){$(this).removeClass("selected").find("i.choose").removeClass("fa fa-check");$(this).find("input").removeAttr("checked")}else{$(this).addClass("selected").find("i.choose").addClass("fa fa-check");$(this).find("input").prop("checked",true)}});$(".optionlist").find("ul li i.optABCD").eq(0).html("A");$(".optionlist").find("ul li i.optABCD").eq(1).html("B");$(".optionlist").find("ul li i.optABCD").eq(2).html("C");$(".optionlist").find("ul li i.optABCD").eq(3).html("D");$(".optionlist").find("ul li i.optABCD").eq(4).html("E");$(".optionlist").find("ul li i.optABCD").eq(5).html("F");$(".optionlist").find("ul li i.optABCD").eq(6).html("G");$(".optionlist").find("ul li i.optABCD").eq(7).html("H");$(".optionlist").find("ul li i.optABCD").eq(8).html("I");$(".optionlist").find("ul li i.optABCD").eq(9).html("J");$(".optionlist").find("ul li i.optABCD").eq(10).html("K");if(!$(".optionlist ul li input:checked").parent().hasClass("selected")){$(".optionlist ul li input:checked").parent().addClass("selected").find("i.choose").addClass("fa fa-check")}$(".examtitle .titleright").show();var paintInit=false;var initPaint=function(){if(!initPaint){paintInit=true}else{openPaint()}};var openPaint=function(){$("#dialog").dialog({modal:true,autoOpen:true,show:{effect:"blind",duration:920},hide:{effect:"explode",duration:920},height:630,width:920})};window.ACMGlobal.drawingboard=function(){initCanvas();if($("#dialog").dialog){initPaint();$(".painterdialog").show()}else{forPaint.push(function(){initPaint();$(".painterdialog").show()})}};window.ACMGlobal.mobile_uploadfile=function(){cxalert(ACM.lang.answer.twoDimensionalCode,'<div id="qrText">'+'<div id="qrCodeViewBox" width="150px" height="150px" style="float:left;"></div>'+'<div class="qrCodeRight">'+ACM.lang.answer.twoDimensionalCodeTip+"</div>"+'<div style="width:550px;float:left">'+'<a href="javascript:void(0)" style="margin-top: 5px;">'+'<span id="qrEror">'+ACM.lang.answer.sweepFailed+"</span> "+"</a>"+'<div style="border: 1px solid rgb(221, 221, 221); float: left; width: 557px; overflow: auto;display: none" id="copyAlert">'+'<span id="copyUrl" style="font-size:12px;"></span> '+'<div style="display: inline-block;font-size: 13px;color: red;text-align: center;width: 100%;">'+ACM.lang.answer.copyLink+"</div>"+"</div>"+"</div>"+"</div>");$("#cxdialog.cxdialog .showtip i.fa").css({display:"none"});$("#cxdialog.cxdialog .showtip tr td:nth-child(2n)").css({"padding-left":"0px"});var qroceCopyUrl=location.origin+"/static/htmls/code/qrcode.html?id="+uploadId;if(ACM.lang.lang=="en"){qroceCopyUrl=location.origin+"/static/htmls/code/qrcode_en.html?id="+uploadId}var qrcode=new QRCode(document.getElementById("qrCodeViewBox"),{text:"your content",width:150,height:150,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.H});qrcode.clear();qrcode.makeCode(qroceCopyUrl);$("#copyUrl").html(qroceCopyUrl);$(".btn_copy").attr("data-clipboard-text",qroceCopyUrl);$("div.cxdialog_btns").prepend('<a class="btn_preview">'+ACM.lang.answer.preview+"</a>").find("a.btn_ok").html(ACM.lang.answer.upload);$("#qrText").find("NaN").remove();$("div.cxdialog_btns").find("a.btn_preview").on("click",function(){$.ajax({url:"/api/previewQuesTu",data:{cpId:uploadId},type:"post",dataType:"json",cache:false,success:function(res){if(res.errno==0){if(res.result!=""){if($("body").find("div.preview").length==0){$("body").append('<div id="cxdialog" class="cxdialog preview" style="margin-left: -351.5px;margin-top: -153.5px;position: fixed;width: 720px;height:500px;top: 33%;" >'+'<div class="cxdialog_title">'+ACM.lang.answer.twoDimensionalCode+'</div><div class="cxdialog_info"><div class="showtip" style="max-width: 100%;padding:0px"><table align="center"><tbody><tr><td><i class="fa fa-exclamation-circle" style="display: none;"></i></td><td style="padding-left: 0px;"><span class="fbig fb"></span><div><h1 style=margin:150px auto" id="reading">'+ACM.lang.answer.loading+'</h1><div id="uploadPhoto" style="float:left;text-align: center;overflow: auto;max-width: 700px;max-height:430px;display:none" ><img src="" style="display: block;" id="previewPs"></div></div></td></tr></tbody></table></div></div><a  id ="cxdialogClose" rel="cxdialogClose" rev="close"></a></div>');setTimeout(function(){$("#reading").hide();$("#uploadPhoto").show();$("#uploadPhoto img").attr("src",res.result)},4e3);tuUrl=res.result}else{$("div.preview").css({display:"block"})}}else{$("div.cxdialog.in").remove();$("#cxdialog_overlay").remove();cxalert(ACM.lang.hint,ACM.lang.answer.noPics)}}$("#cxdialogClose").on("click",function(){$("div.preview").remove();$("div.cxdialog.in").find("a:last").trigger("click")})},error:function(res){alert(res.errmsg)}})});$("div.cxdialog.in").find("a:last").on("click",function(){if($("iframe").length>0){var iframe;try{iframe=$("iframe").contents().find("body.cke_editable")}catch(e){iframe=$($("iframe.cke_wysiwyg_frame")[0].contentDocument.body)}$.ajax({url:"/api/previewQuesTu",data:{cpId:uploadId},type:"post",dataType:"json",cache:false,aysn:true,success:function(res){if(res.errno==0){if(res.result!=""){iframe.find("img").each(function(){if($(this).attr("src").indexOf("data:")==-1){$(this).remove()}});editor.insertHtml('<img style="max-width: 400px;" src='+res.result+' id="uploadTestImg">');tuUrl=res.result}}},error:function(res){alert(res.errmsg)}})}else{cxalert(ACM.lang.hint,ACM.lang.answer.changeBrowser)}});$("a.btn_ok").on("click",function(){$.ajax({url:"/api/previewQuesTu",data:{cpId:uploadId},type:"post",dataType:"json",cache:false,success:function(res){if(res.errno==0){if(res.result==""){cxalert(ACM.lang.hint,ACM.lang.answer.noPics)}}},error:function(res){alert(res.errmsg)}});$("div.cxdialog.in").find("a:last").trigger("click")});$("#qrEror").on("click",function(){if($("#copyAlert").is(":hidden")){$("#copyAlert").css({display:"block"})}else{$("#copyAlert").css({display:"none"})}})};var fileupload=function(){$("#fileText").on("change",function(){$scope.uploadStart()})};window.ACMGlobal.fileTextuploadfile=function(){$("#fileText").trigger("click");fileupload()};$(".fileTextuploadfile").unbind("click").bind("click",window.ACMGlobal.fileTextuploadfile);var initCanvas=function(){document.getElementById("myCanvas").getContext("2d").fillStyle="#FFFFFF";var width=$("#myCanvas").attr("width");var height=$("#myCanvas").attr("height");document.getElementById("myCanvas").getContext("2d").fillRect(0,0,width,height);var imgOld=$($("iframe.cke_wysiwyg_frame")[0].contentDocument.body).find('img[src^="data:"]');var oldImg=null;for(var i=0;i<imgOld.length;i++){var a=$(imgOld[i]);if(Object.isNullString(a.attr("class"))){oldImg=a;break}}if(oldImg){var getimgdate=oldImg;document.getElementById("myCanvas").getContext("2d").drawImage(getimgdate[0],0,0)}};window.ACMGlobal.initHightLight=function(){if(typeof hljs!="undefined"){window.clearInterval(initHightLightTimer);hljs.initHighlighting.called=false;hljs.initHighlighting()}};window.initHightLightTimer=window.setInterval("window.ACMGlobal.initHightLight()",200);if($scope.model.fileUrl!=undefined&&$scope.model.fileUrl!=""){$("#loaclFileDiv").show()}window.ACM.loadIntroJs=function(){if($scope.model.paper.allQuesPanel!=0){$(".nav .examlist").attr("data-step","2").attr("data-intro",$(".nav .examlist").attr("data-intro1")).show()}else{$(".nav .examlist").removeAttr("data-step").removeAttr("data-intro")}$(".noticeTips").show();if($(".onlineRefer.mianli").length>0){if($.cookie("introJsforanswer")==null&&isMobile==false&&(location.hash.indexOf("main/answer")>-1||location.hash.indexOf("main/onlinecode")>-1)){$.cookie("introJsforanswer","1");if($scope.model.forPractise==$scope.model.forPractise&&$scope.model.rowNumber==0){introJs().setOptions({doneLabel:ACM.lang.iknow,nextLabel:ACM.lang.iknow,showBullets:false,showStepNumbers:false,tooltipPosition:"auto"}).start()}}}else{$timeout(function(){if(window.ACM&&window.ACM.loadIntroJs){window.ACM.loadIntroJs()}},1e3)}};window.ACM.loadIntroJs()});App.updateFromServer($http,$state);App.updatePaperServer($http,App.paper._id);$timeout(function(){$(".examtitle").show();if($(".examtitle").find(".titleright").length==0){$(".examtitle").append('<div class="titleright"><span class="type"></span> <span class="Num" id="Nums"></span><span id="pointer">/</span><span class="total" id="totals"></span></div>')}$(".examtitle .titleright .type").html(App.paper.title);$(".examtitle .titleright .type").attr("title",App.paper.title);$(".examtitle .titleright .Num").html(parseInt($scope.model.rowNumber/100)+1);$(".examtitle .titleright .total").html(App.paper.quesNum)});if(window.autoSave!=undefined){window.clearInterval(window.autoSave)}window.autoSaveFun=function(){if($scope.model.ques.questype==5){var ans=$scope.getAnswer();if($scope.checkAnswer2(ans,1)!="limited500"&&location.hash.indexOf("answer")>-1){$scope.saveAnswerActionFun(ans,function(){})}}};window.autoSave=window.setInterval("window.autoSaveFun()",12e4);window.ACMGlobal.quesTime=0;if(window.saveUseTime!=undefined){window.clearInterval(window.saveUseTime)}window.saveUseTimeFun=function(){window.ACMGlobal.quesTime++;if(window.ACMGlobal.quesTime%3==0){$.post("/cand/api/addCalculateTime",{cpid:$scope.model._id},function(data){var encrypt=new JSEncrypt;encrypt.setPrivateKey($scope.private);data=encrypt.decrypt(data);if(data==null||data!=="true"){cxalert(ACM.lang.hint,ACM.lang.main.netWrong3Limit,function(){location.href="/cand/login"});$timeout(function(){location.href="/cand/login"},2e3)}})}}};$scope.refreshFunc=refreshFunc;refreshFunc();window.onfocus=function(){console.log("FOCUS");if(blurTime){console.log("clear BLUR");clearTimeout(blurTime);blurTime=null}if(detectTimer){console.log("clear detectTimer");clearTimeout(detectTimer);detectTimer=null}$http.post("/cand/api/focusLog",{paperId:$scope.paperId,quesNo:$scope.model.rowNumber,focus:"QUES_FOCUS"}).success(function(data){}).error(function(data){console.log(data)})}}]);